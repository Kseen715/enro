name: Build and Release

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  check-version-and-tag:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      should_release: ${{ steps.tag_check.outputs.should_release }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all tags and branches

      - name: Extract version from Cargo.toml
        id: version
        run: |
          VERSION=$(grep -m 1 "^version =" Cargo.toml | cut -d '"' -f 2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Check if tag exists
        id: tag_check
        run: |
          TAG="v${{ steps.version.outputs.version }}"
          if git tag --list | grep -x "$TAG" > /dev/null; then
            echo "Tag $TAG already exists"
            echo "should_release=false" >> $GITHUB_OUTPUT
          else
            echo "Tag $TAG does not exist"
            echo "should_release=true" >> $GITHUB_OUTPUT
          fi

      - name: Create tag if it doesn't exist
        if: steps.tag_check.outputs.should_release == 'true'
        run: |
          TAG="v${{ steps.version.outputs.version }}"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag -a "$TAG" -m "Release version ${{ steps.version.outputs.version }}"
          git push origin "$TAG"

  build:
    needs: check-version-and-tag
    if: needs.check-version-and-tag.outputs.should_release == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux_x86_64
            cross: false
          - os: ubuntu-latest
            target: i686-unknown-linux-gnu
            platform: linux_x86
            cross: true
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            platform: linux_aarch64
            cross: true
          - os: ubuntu-latest
            target: armv7-unknown-linux-gnueabihf
            platform: linux_armv7
            cross: true
          - os: ubuntu-latest
            target: x86_64-pc-windows-msvc
            platform: win_x86_64
            cross: true
          - os: ubuntu-latest
            target: i686-pc-windows-msvc
            platform: win_x86
            cross: true
          - os: ubuntu-latest
            target: aarch64-pc-windows-msvc
            platform: win_aarch64
            cross: true
          - os: ubuntu-latest
            target: x86_64-apple-darwin
            platform: mac_x86_64
            cross: true
          - os: ubuntu-latest
            target: aarch64-apple-darwin
            platform: mac_aarch64
            cross: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross
        uses: taiki-e/install-action@v2
        with:
          tool: cross

      - name: Build for target
        run: |
          if [ "${{ matrix.cross }}" = "true" ]; then
            cross build --target ${{ matrix.target }} --release
          else
            cargo build --target ${{ matrix.target }} --release
          fi

      - name: Create artifacts directory
        run: |
          mkdir -p artifacts
          if [ "${{ runner.os }}" = "Windows" ]; then
            cp target/${{ matrix.target }}/release/enro.exe artifacts/
          else
            cp target/${{ matrix.target }}/release/enro artifacts/
          fi

      - name: Create installer packages (Linux)
        if: contains(matrix.os, 'ubuntu')
        run: |
          cd artifacts

          # Determine architecture based on target
          if [ "${{ matrix.target }}" = "i686-unknown-linux-gnu" ]; then
            ARCH="i686"
          elif [ "${{ matrix.target }}" = "x86_64-unknown-linux-gnu" ]; then
            ARCH="x86_64"
          elif [ "${{ matrix.target }}" = "aarch64-unknown-linux-gnu" ]; then
            ARCH="aarch64"
          elif [ "${{ matrix.target }}" = "armv7-unknown-linux-gnueabihf" ]; then
            ARCH="armv7"
          fi

          # Create tar.gz
          tar -czf "enro-${{ needs.check-version-and-tag.outputs.version }}-${{ matrix.platform }}.tar.gz" enro

          # Create .deb package
          mkdir -p enro-deb/usr/local/bin
          mkdir -p enro-deb/DEBIAN
          cp enro enro-deb/usr/local/bin/
          chmod +x enro-deb/usr/local/bin/enro

          # Control file for .deb
          cat << EOF > enro-deb/DEBIAN/control
          Package: enro
          Version: ${{ needs.check-version-and-tag.outputs.version }}
          Section: utils
          Priority: optional
          Architecture: $ARCH
          Depends:
          Maintainer: D.N. Korenev
          Description: A command-line tool for file type detection and entropy analysis
          EOF

          dpkg-deb --build enro-deb
          mv enro-deb.deb enro-${{ needs.check-version-and-tag.outputs.version }}-${{ matrix.platform }}.deb

          # Create .rpm package
          sudo apt-get update
          sudo apt-get install -y rpm

          mkdir -p enro-rpm/{BUILD,BUILDROOT,RPMS,SOURCES,SPECS}
          cp enro enro-rpm/BUILD/

          # Create .spec file
          cat << EOF > enro-rpm/SPECS/enro.spec
          Name:           enro
          Version:        ${{ needs.check-version-and-tag.outputs.version }}
          Release:        1%{?dist}
          Summary:        A command-line tool for file type detection and entropy analysis

          License:        BSD
          BuildArch:      $ARCH

          %description
          A command-line tool for file type detection and entropy analysis

          %files
          /usr/local/bin/enro

          %changelog
          * $(date +"%%a %%b %%d %%Y") D.N. Korenev <https://github.com/Kseen715> - ${{ needs.check-version-and-tag.outputs.version }}-1
          - Initial package
          EOF

          rpmbuild -bb enro-rpm/SPECS/enro.spec --target $ARCH --define "_topdir $(pwd)/enro-rpm"

          # Find and move the RPM to current directory with a clear name
          RPM_FILE=$(find enro-rpm/RPMS -name "*.rpm" -type f)
          if [ -n "$RPM_FILE" ]; then
            mv "$RPM_FILE" enro-${{ needs.check-version-and-tag.outputs.version }}-${{ matrix.platform }}.rpm
          fi

      - name: Create installer packages (Windows)
        if: contains(matrix.os, 'windows')
        run: |
          cd artifacts

          # Create zip archive
          Compress-Archive -Path enro.exe -DestinationPath "enro-${{ needs.check-version-and-tag.outputs.version }}-${{ matrix.platform }}.zip"

          # Create MSI installer using WiX Toolset
          # For now, we'll just create a zip as a placeholder for Windows installer
          # Full MSI creation would require more complex WiX configuration
        shell: pwsh

      - name: Create installer packages (macOS)
        if: contains(matrix.os, 'macos')
        run: |
          cd artifacts

          # Create tar.gz
          if [ "${{ matrix.target }}" = "x86_64-apple-darwin" ]; then
            ARCH="x86_64"
          elif [ "${{ matrix.target }}" = "aarch64-apple-darwin" ]; then
            ARCH="aarch64"
          fi

          tar -czf "enro-${{ needs.check-version-and-tag.outputs.version }}-${ARCH}.tar.gz" enro

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}
          path: artifacts/*

  release:
    needs: [check-version-and-tag, build]
    runs-on: ubuntu-latest
    if: needs.check-version-and-tag.outputs.should_release == 'true'
    permissions:
      contents: write  # for creating releases

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.check-version-and-tag.outputs.version }}
          release_name: "Release v${{ needs.check-version-and-tag.outputs.version }}"
          draft: false
          prerelease: false
          files: |
            all_artifacts/**/*
          body: |
            ## Release v${{ needs.check-version-and-tag.outputs.version }}

            This release includes builds for multiple platforms:
            - Windows (x86, x64, ARM64)
            - macOS (x64, ARM64)
            - Linux (x86, x64, ARMv7, ARMv8)

            The release includes various installer formats:
            - ZIP archives for Windows and macOS
            - tar.gz archives for all platforms
            - DEB packages for Debian/Ubuntu Linux
            - RPM packages for RedHat/Fedora Linux
